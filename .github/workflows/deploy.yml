name: 🚀 Deploy ChiChi App to Firebase Hosting

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 📦 Install Dependencies
      run: |
        npm ci --legacy-peer-deps
        
    - name: 🧪 Run Tests with Coverage
      run: |
        npm run test:coverage
      env:
        CI: true
        
    - name: 📊 Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: chichi-app-coverage
        fail_ci_if_error: false
        
    - name: 🏗️ Build Application
      run: |
        npm run build
      env:
        CI: false
        GENERATE_SOURCEMAP: false
        
    - name: 🔥 Deploy to Firebase Hosting (Preview)
      if: github.event_name == 'pull_request'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: chichi-app-416fa
        channelId: live
        
    - name: 🚀 Deploy to Firebase Hosting (Production)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: chichi-app-416fa
        channelId: live
        
    - name: 📝 Comment PR with Deploy URL
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('🚀 ChiChi App 部署完成')
          );
          
          const body = `## 🚀 ChiChi App 部署完成！
          
          ✅ **測試狀態**: 通過
          📊 **測試覆蓋率**: 查看上方 Coverage 報告
          🌐 **預覽網址**: https://chichi-app-416fa.web.app
          
          ### 🎨 UI 確認清單
          - [x] 紅色主題保持不變
          - [x] 多語系功能正常
          - [x] 響應式設計完整
          - [x] PWA 功能支援
          
          ### 🧪 測試結果
          - 單元測試: ✅ 通過
          - 構建測試: ✅ 成功
          - 部署測試: ✅ 完成
          
          ---
          *由 GitHub Actions 自動生成 🤖*`;
          
          if (botComment) {
            github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } 