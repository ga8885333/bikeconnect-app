<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>探索</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet 地圖 (免費，無需API Key) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* 夜間模式支持 */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --card-bg: #374151;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
        }

        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .card-bg {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }

        .map-container {
            background: linear-gradient(45deg, #fef3c7, #fed7aa);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(251, 191, 36, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
        }
        .route-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .filter-chip {
            transition: all 0.2s ease;
        }
        .filter-chip.active {
            background: #f59e0b;
            color: white;
        }
        
        /* 定位按鈕特殊樣式 */
        #centerLocationBtn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: 3px solid rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            animation: locationPulse 2s infinite;
            z-index: 1000;
            position: relative;
        }
        
        #centerLocationBtn:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        #centerLocationBtn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        @keyframes locationPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            }
            50% {
                box-shadow: 0 4px 25px rgba(245, 158, 11, 0.5);
            }
        }
        
        /* 當前位置標記樣式 */
        .current-location-marker {
            animation: locationBlink 1.5s infinite;
        }
        
        @keyframes locationBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* 確保地圖控件在正確層級 */
        .leaflet-control-container {
            z-index: 999;
        }
        
        /* 地圖本身 */
        #map {
            z-index: 1;
        }
    </style>
</head>
<body>
    <!-- 搜尋欄 -->
    <div class="card-bg p-4 border-b">
        <div class="relative">
            <input type="text" id="searchInput" placeholder="搜尋地點、路線或騎友..." 
                   class="w-full pl-10 pr-16 py-3 rounded-xl border-none focus:ring-2 focus:ring-amber-500 focus:outline-none text-primary" 
                   style="background-color: var(--bg-tertiary);">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary"></i>
            <button id="searchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-amber-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-amber-600 transition-colors">
                搜尋
            </button>
        </div>
        
        <!-- 快速搜尋建議 -->
        <div class="flex space-x-2 mt-3 overflow-x-auto pb-1">
            <button class="quick-search flex-shrink-0 bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm" data-location="板橋區">
                📍 板橋區
            </button>
            <button class="quick-search flex-shrink-0 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm" data-location="淡水">
                🌊 淡水
            </button>
            <button class="quick-search flex-shrink-0 bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm" data-location="陽明山">
                🏔️ 陽明山
            </button>
            <button class="quick-search flex-shrink-0 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm" data-location="信義區">
                🏙️ 信義區
            </button>
        </div>
    </div>

    <!-- 地圖視圖 -->
    <div class="relative">
        <div id="map" class="h-64 border-b"></div>
        <!-- 地圖控制按鈕 -->
        <div class="absolute top-4 right-4 space-y-2">
            <button id="currentLocationBtn" class="card-bg rounded-full w-12 h-12 shadow-lg flex items-center justify-center hover:shadow-xl transition-shadow">
                <i class="fas fa-location-arrow text-amber-600"></i>
            </button>
            <button id="landmarksBtn" class="card-bg rounded-full w-12 h-12 shadow-lg flex items-center justify-center hover:shadow-xl transition-shadow">
                <i class="fas fa-map-marker-alt text-secondary"></i>
            </button>
        </div>
        
        <!-- 主要定位按鈕 -->
        <div class="absolute bottom-24 right-4 z-50">
            <button id="centerLocationBtn" class="bg-amber-600 hover:bg-amber-700 text-white rounded-full w-16 h-16 shadow-xl flex items-center justify-center transition-all duration-200 hover:scale-105">
                <i class="fas fa-crosshairs text-2xl"></i>
            </button>
        </div>
        
        <!-- 地圖底部操作欄 -->
        <div class="absolute bottom-4 left-4 right-4">
            <div class="card-bg rounded-xl p-3 shadow-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-yellow-100 rounded-full p-2">
                            <i class="fas fa-coffee text-yellow-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-primary">熱門地標</p>
                            <p class="text-xs text-tertiary">點擊地標使用原生導航</p>
                        </div>
                    </div>
                    <button id="toggleLandmarks" class="text-amber-600 font-medium">顯示</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 篩選標籤 -->
    <div class="p-4">
        <div class="flex space-x-2 overflow-x-auto pb-2">
            <button class="filter-chip active flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
                全部
            </button>
            <button class="filter-chip flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
                <i class="fas fa-mountain mr-1"></i>
                爬坡路線
            </button>
            <button class="filter-chip flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
                <i class="fas fa-leaf mr-1"></i>
                休閒路線
            </button>
            <button class="filter-chip flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
                <i class="fas fa-road mr-1"></i>
                公路騎行
            </button>
            <button class="filter-chip flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
                <i class="fas fa-tree mr-1"></i>
                越野路線
            </button>
        </div>
    </div>

    <!-- 熱門路線 -->
    <div class="px-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg text-primary">熱門路線</h3>
            <button class="text-amber-600 font-medium">查看更多</button>
        </div>
        
        <div class="space-y-4">
            <!-- 路線卡片1 -->
            <div class="route-card card-bg rounded-xl shadow-sm border overflow-hidden transition-all duration-200">
                <div class="h-32 bg-gradient-to-r from-green-400 to-blue-500 relative">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-image text-white text-3xl opacity-75"></i>
                    </div>
                    <!-- 優化難度標籤 -->
                    <div class="absolute top-3 left-3 flex space-x-2">
                        <span class="bg-green-500 text-white text-xs px-3 py-1 rounded-full font-medium flex items-center">
                            <i class="fas fa-leaf mr-1"></i>初級
                        </span>
                        <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">
                            <i class="fas fa-dumbbell mr-1"></i>輕鬆
                        </span>
                    </div>
                    <div class="absolute top-3 right-3">
                        <button class="bg-white/20 backdrop-blur-sm rounded-full w-8 h-8 flex items-center justify-center">
                            <i class="far fa-heart text-white"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <h4 class="font-semibold text-primary mb-2">淡水河濱自行車道</h4>
                    <p class="text-sm text-secondary mb-3">沿河風景優美，適合全家大小的休閒路線</p>
                    
                    <!-- 詳細難度信息 -->
                    <div class="bg-gray-50 rounded-lg p-3 mb-3" style="background-color: var(--bg-tertiary);">
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="text-center">
                                <div class="text-green-600 font-semibold">坡度</div>
                                <div class="text-secondary">平緩</div>
                            </div>
                            <div class="text-center">
                                <div class="text-blue-600 font-semibold">路況</div>
                                <div class="text-secondary">優良</div>
                            </div>
                            <div class="text-center">
                                <div class="text-purple-600 font-semibold">風景</div>
                                <div class="text-secondary">★★★★☆</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center space-x-4 text-tertiary">
                            <span><i class="fas fa-route mr-1"></i>18.5km</span>
                            <span><i class="fas fa-clock mr-1"></i>1.2小時</span>
                            <span><i class="fas fa-fire mr-1"></i>320卡</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span class="font-medium">4.8</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t" style="border-color: var(--border-color);">
                        <div class="flex items-center space-x-2">
                            <div class="flex -space-x-2">
                                <img src="https://via.placeholder.com/24x24/3b82f6/ffffff?text=A" class="w-6 h-6 rounded-full border-2 border-white">
                                <img src="https://via.placeholder.com/24x24/8b5cf6/ffffff?text=B" class="w-6 h-6 rounded-full border-2 border-white">
                                <img src="https://via.placeholder.com/24x24/f59e0b/ffffff?text=C" class="w-6 h-6 rounded-full border-2 border-white">
                            </div>
                            <span class="text-xs text-tertiary">+127位騎友</span>
                        </div>
                        <button class="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">
                            開始騎行
                        </button>
                    </div>
                </div>
            </div>

            <!-- 路線卡片2 -->
            <div class="route-card card-bg rounded-xl shadow-sm border overflow-hidden transition-all duration-200">
                <div class="h-32 bg-gradient-to-r from-orange-400 to-red-500 relative">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-image text-white text-3xl opacity-75"></i>
                    </div>
                    <!-- 優化難度標籤 -->
                    <div class="absolute top-3 left-3 flex space-x-2">
                        <span class="bg-orange-500 text-white text-xs px-3 py-1 rounded-full font-medium flex items-center">
                            <i class="fas fa-mountain mr-1"></i>中級
                        </span>
                        <span class="bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">
                            <i class="fas fa-dumbbell mr-1"></i>中等
                        </span>
                    </div>
                    <div class="absolute top-3 right-3">
                        <button class="bg-white/20 backdrop-blur-sm rounded-full w-8 h-8 flex items-center justify-center">
                            <i class="fas fa-heart text-red-500"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <h4 class="font-semibold text-primary mb-2">陽明山國家公園</h4>
                    <p class="text-sm text-secondary mb-3">挑戰性爬坡路線，山頂風景絕佳</p>
                    
                    <!-- 詳細難度信息 -->
                    <div class="bg-gray-50 rounded-lg p-3 mb-3" style="background-color: var(--bg-tertiary);">
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="text-center">
                                <div class="text-orange-600 font-semibold">坡度</div>
                                <div class="text-secondary">陡峭</div>
                            </div>
                            <div class="text-center">
                                <div class="text-yellow-600 font-semibold">路況</div>
                                <div class="text-secondary">良好</div>
                            </div>
                            <div class="text-center">
                                <div class="text-purple-600 font-semibold">風景</div>
                                <div class="text-secondary">★★★★★</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center space-x-4 text-tertiary">
                            <span><i class="fas fa-route mr-1"></i>25.8km</span>
                            <span><i class="fas fa-clock mr-1"></i>2.5小時</span>
                            <span><i class="fas fa-fire mr-1"></i>850卡</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span class="font-medium">4.6</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t" style="border-color: var(--border-color);">
                        <div class="flex items-center space-x-2">
                            <div class="flex -space-x-2">
                                <img src="https://via.placeholder.com/24x24/ef4444/ffffff?text=D" class="w-6 h-6 rounded-full border-2 border-white">
                                <img src="https://via.placeholder.com/24x24/22c55e/ffffff?text=E" class="w-6 h-6 rounded-full border-2 border-white">
                            </div>
                            <span class="text-xs text-tertiary">+83位騎友</span>
                        </div>
                        <button class="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">
                            開始騎行
                        </button>
                    </div>
                </div>
            </div>

            <!-- 路線卡片3 -->
            <div class="route-card card-bg rounded-xl shadow-sm border overflow-hidden transition-all duration-200">
                <div class="h-32 bg-gradient-to-r from-purple-400 to-pink-500 relative">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-image text-white text-3xl opacity-75"></i>
                    </div>
                    <!-- 優化難度標籤 -->
                    <div class="absolute top-3 left-3 flex space-x-2">
                        <span class="bg-red-500 text-white text-xs px-3 py-1 rounded-full font-medium flex items-center">
                            <i class="fas fa-fire mr-1"></i>高級
                        </span>
                        <span class="bg-red-600 text-white text-xs px-2 py-1 rounded-full">
                            <i class="fas fa-dumbbell mr-1"></i>困難
                        </span>
                    </div>
                    <div class="absolute top-3 right-3">
                        <button class="bg-white/20 backdrop-blur-sm rounded-full w-8 h-8 flex items-center justify-center">
                            <i class="far fa-heart text-white"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <h4 class="font-semibold text-primary mb-2">北海岸環島路線</h4>
                    <p class="text-sm text-secondary mb-3">海景公路，適合重機騎士的長途路線</p>
                    
                    <!-- 詳細難度信息 -->
                    <div class="bg-gray-50 rounded-lg p-3 mb-3" style="background-color: var(--bg-tertiary);">
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="text-center">
                                <div class="text-red-600 font-semibold">坡度</div>
                                <div class="text-secondary">多變</div>
                            </div>
                            <div class="text-center">
                                <div class="text-orange-600 font-semibold">路況</div>
                                <div class="text-secondary">複雜</div>
                            </div>
                            <div class="text-center">
                                <div class="text-purple-600 font-semibold">風景</div>
                                <div class="text-secondary">★★★★★</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center space-x-4 text-tertiary">
                            <span><i class="fas fa-route mr-1"></i>68.2km</span>
                            <span><i class="fas fa-clock mr-1"></i>4.5小時</span>
                            <span><i class="fas fa-fire mr-1"></i>1250卡</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span class="font-medium">4.9</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t" style="border-color: var(--border-color);">
                        <div class="flex items-center space-x-2">
                            <div class="flex -space-x-2">
                                <img src="https://via.placeholder.com/24x24/6366f1/ffffff?text=F" class="w-6 h-6 rounded-full border-2 border-white">
                                <img src="https://via.placeholder.com/24x24/10b981/ffffff?text=G" class="w-6 h-6 rounded-full border-2 border-white">
                                <img src="https://via.placeholder.com/24x24/f97316/ffffff?text=H" class="w-6 h-6 rounded-full border-2 border-white">
                            </div>
                            <span class="text-xs text-tertiary">+45位騎友</span>
                        </div>
                        <button class="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">
                            開始騎行
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 附近騎友 -->
    <div class="px-4 mt-8">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg text-primary">附近騎友</h3>
            <button class="text-amber-600 font-medium">查看更多</button>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div class="card-bg rounded-xl p-4 shadow-sm border">
                <div class="flex items-center space-x-3 mb-3">
                    <img src="https://via.placeholder.com/40x40/3b82f6/ffffff?text=A" class="w-10 h-10 rounded-full">
                    <div>
                        <h4 class="font-medium text-primary">阿強</h4>
                        <p class="text-xs text-tertiary">0.8km • 線上</p>
                    </div>
                </div>
                <div class="text-xs text-secondary mb-3">
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">重機</span>
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full ml-1">新手</span>
                </div>
                <button class="w-full bg-amber-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">
                    打招呼
                </button>
            </div>
            
            <div class="card-bg rounded-xl p-4 shadow-sm border">
                <div class="flex items-center space-x-3 mb-3">
                    <img src="https://via.placeholder.com/40x40/8b5cf6/ffffff?text=M" class="w-10 h-10 rounded-full">
                    <div>
                        <h4 class="font-medium text-primary">小美</h4>
                        <p class="text-xs text-tertiary">1.2km • 騎行中</p>
                    </div>
                </div>
                <div class="text-xs text-secondary mb-3">
                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">公路車</span>
                    <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full ml-1">老手</span>
                </div>
                <button class="w-full bg-amber-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">
                    開始騎行
                </button>
            </div>
        </div>
    </div>

    <!-- 底部空間 -->
    <div class="h-20"></div>

    <script>
        // 簡化版地圖功能 (使用 Leaflet)
        let map;
        let currentLocationMarker;
        let landmarkMarkers = [];
        let userLocation = null;
        let landmarksVisible = false;
        
        // 熱門地標數據
        const landmarks = [
            {
                name: "板橋車站星巴克",
                position: [25.0138, 121.4627], // Leaflet使用 [lat, lng] 格式
                category: "咖啡廳",
                icon: "☕",
                color: "#8B4513"
            },
            {
                name: "淡水老街",
                position: [25.1757, 121.4413],
                category: "景點",
                icon: "🏮",
                color: "#FF6B6B"
            },
            {
                name: "陽明山國家公園",
                position: [25.1903, 121.5494],
                category: "景點",
                icon: "🏔️",
                color: "#4ECDC4"
            },
            {
                name: "信義區新光三越",
                position: [25.0360, 121.5636],
                category: "購物",
                icon: "🛍️",
                color: "#45B7D1"
            },
            {
                name: "士林夜市",
                position: [25.0881, 121.5240],
                category: "美食",
                icon: "🍜",
                color: "#F39C12"
            },
            {
                name: "西門町",
                position: [25.0421, 121.5071],
                category: "景點",
                icon: "🎬",
                color: "#9B59B6"
            },
            {
                name: "中正紀念堂",
                position: [25.0361, 121.5200],
                category: "景點",
                icon: "🏛️",
                color: "#E74C3C"
            },
            {
                name: "台北101",
                position: [25.0340, 121.5645],
                category: "景點",
                icon: "🏗️",
                color: "#2ECC71"
            }
        ];
        
        // 初始化地圖
        function initMap() {
            // 預設位置：台北車站
            const defaultLocation = [25.0478, 121.5170];
            
            // 創建 Leaflet 地圖
            map = L.map('map').setView(defaultLocation, 12);
            
            // 添加地圖圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // 嘗試獲取用戶位置
            getCurrentLocation();
            
            console.log('🗺️ Leaflet 地圖已初始化');
        }
        
        // 獲取當前位置 (增強版)
        function getCurrentLocation(showLoading = false) {
            const locationBtn = document.getElementById('centerLocationBtn');
            const currentBtn = document.getElementById('currentLocationBtn');
            
            if (showLoading) {
                // 顯示載入狀態
                locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xl"></i>';
                locationBtn.disabled = true;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    userLocation = [position.coords.latitude, position.coords.longitude];
                    
                    // 添加當前位置標記
                    if (currentLocationMarker) {
                        currentLocationMarker.remove();
                    }
                    
                    // 創建藍色標記表示當前位置
                    const blueIcon = L.divIcon({
                        className: 'current-location-marker',
                        html: '<div style="background-color: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    currentLocationMarker = L.marker(userLocation, { icon: blueIcon }).addTo(map)
                        .bindPopup('📍 您的位置')
                        .openPopup();
                    
                    // 移動地圖到當前位置
                    map.setView(userLocation, 16);
                    
                    // 恢復按鈕狀態
                    if (showLoading) {
                        locationBtn.innerHTML = '<i class="fas fa-crosshairs text-xl"></i>';
                        locationBtn.disabled = false;
                        
                        // 短暫顯示成功狀態
                        locationBtn.classList.add('bg-green-600');
                        setTimeout(() => {
                            locationBtn.classList.remove('bg-green-600');
                        }, 1000);
                    }
                    
                    console.log('📍 已獲取當前位置');
                }, (error) => {
                    console.log('❌ 無法獲取位置:', error.message);
                    
                    // 恢復按鈕狀態並顯示錯誤
                    if (showLoading) {
                        locationBtn.innerHTML = '<i class="fas fa-exclamation-triangle text-xl"></i>';
                        locationBtn.classList.add('bg-red-600');
                        
                        setTimeout(() => {
                            locationBtn.innerHTML = '<i class="fas fa-crosshairs text-xl"></i>';
                            locationBtn.classList.remove('bg-red-600');
                            locationBtn.disabled = false;
                        }, 2000);
                    }
                    
                    // 顯示錯誤提示
                    alert('無法獲取位置資訊\n請確認：\n1. 已允許位置存取權限\n2. GPS功能已開啟\n3. 網路連線正常');
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            } else {
                alert('您的瀏覽器不支援地理定位功能');
                if (showLoading) {
                    locationBtn.innerHTML = '<i class="fas fa-crosshairs text-xl"></i>';
                    locationBtn.disabled = false;
                }
            }
        }
        
        // 簡化搜尋功能 (使用 Nominatim API)
        async function searchLocation(query) {
            try {
                console.log(`🔍 開始搜尋: ${query}`);
                
                // 預處理查詢字串 - 嘗試多種格式
                const searchQueries = [
                    query + ', Taiwan',
                    query + ', 台灣',
                    query.replace(/台北市|新北市/, '') + ', Taipei, Taiwan',
                    query.replace(/台灣|台北市|新北市/, '') + ', Taiwan'
                ];
                
                // 如果是詳細地址，嘗試更多格式
                if (query.includes('街') || query.includes('路') || query.includes('號')) {
                    const addr = query.replace(/台北市|新北市|桃園市/, '').replace(/區/, '');
                    searchQueries.push(addr + ', Taipei');
                    searchQueries.push(addr + ', Taiwan');
                    
                    // 提取街道名稱
                    const streetMatch = query.match(/([\u4e00-\u9fff]+街|[\u4e00-\u9fff]+路)/);
                    if (streetMatch) {
                        searchQueries.push(streetMatch[1] + ', Taipei, Taiwan');
                    }
                }
                
                // 嘗試每個搜尋查詢
                for (const searchQuery of searchQueries) {
                    console.log(`🔍 嘗試: ${searchQuery}`);
                    
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=3&countrycodes=tw&addressdetails=1`);
                    const results = await response.json();
                    
                    if (results.length > 0) {
                        const result = results[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        
                        map.setView([lat, lng], 17);
                        
                        // 添加搜尋結果標記
                        const marker = L.marker([lat, lng]).addTo(map);
                        marker.bindPopup(`
                            <div style="text-align: center; padding: 5px;">
                                <h4 style="margin: 0 0 5px 0; font-weight: bold;">📍 ${result.display_name}</h4>
                                <button onclick="openInNativeMapFromPopup('${result.display_name.replace(/'/g, "\\'")}', ${lat}, ${lng})" 
                                        style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    🗺️ 導航
                                </button>
                            </div>
                        `).openPopup();
                        
                        console.log(`✅ 找到: ${result.display_name}`);
                        return;
                    }
                }
                
                // 如果都找不到，顯示建議
                alert(`找不到 "${query}"\n\n💡 建議：\n• 試試 "中山區興安街"\n• 或使用地標名稱\n• 或簡化為路名如 "興安街"`);
                
            } catch (error) {
                console.error('搜尋失敗:', error);
                alert('搜尋失敗，請檢查網路連線');
            }
        }
        
        // 增強版地址搜尋 - 如果主搜尋失敗，嘗試Google Geocoding
        async function enhancedAddressSearch(query) {
            try {
                // 首先嘗試標準搜尋
                await searchLocation(query);
            } catch (error) {
                console.log('標準搜尋失敗，嘗試增強搜尋...');
                
                // 備選方案：使用不同的API端點
                try {
                    const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query + ' taiwan')}&limit=3`);
                    const data = await response.json();
                    
                    if (data.features && data.features.length > 0) {
                        const feature = data.features[0];
                        const [lng, lat] = feature.geometry.coordinates;
                        
                        map.setView([lat, lng], 17);
                        
                        const marker = L.marker([lat, lng]).addTo(map);
                        marker.bindPopup(`
                            <div style="text-align: center; padding: 5px;">
                                <h4 style="margin: 0 0 5px 0; font-weight: bold;">📍 ${feature.properties.name || query}</h4>
                                <p style="margin: 0 0 5px 0; font-size: 11px;">${feature.properties.city || ''}</p>
                                <button onclick="openInNativeMapFromPopup('${query}', ${lat}, ${lng})" 
                                        style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    🗺️ 導航
                                </button>
                            </div>
                        `).openPopup();
                        
                        console.log('✅ 使用備選搜尋找到地點');
                    } else {
                        // 最後建議
                        showDetailedSearchHelp(query);
                    }
                } catch (backupError) {
                    showDetailedSearchHelp(query);
                }
            }
        }
        
        // 詳細搜尋說明
        function showDetailedSearchHelp(query) {
            const helpText = `
找不到 "${query}" 😔

🔍 搜尋技巧：
• 完整地址：台北市中山區興安街
• 簡化地址：中山區興安街  
• 只用路名：興安街
• 附近地標：中山國小、行天宮

📍 推薦格式：
• 區域 + 街道：「中山區興安街」
• 地標名稱：「台北車站」
• 商圈名稱：「西門町」

💡 提示：台灣的詳細門牌號碼可能無法精確搜尋，
建議搜尋到街道後再使用導航功能。
            `.trim();
            
            alert(helpText);
        }
        
        // 顯示/隱藏地標
        function toggleLandmarks() {
            if (landmarksVisible) {
                hideLandmarks();
            } else {
                showLandmarks();
            }
        }
        
        // 顯示地標
        function showLandmarks() {
            landmarks.forEach(landmark => {
                // 創建自定義圖標
                const customIcon = L.divIcon({
                    className: 'custom-landmark-marker',
                    html: `<div style="
                        background-color: ${landmark.color}; 
                        width: 40px; 
                        height: 40px; 
                        border-radius: 50%; 
                        border: 3px solid white; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 16px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        cursor: pointer;
                    ">${landmark.icon}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20],
                    popupAnchor: [0, -20]
                });
                
                const marker = L.marker(landmark.position, { icon: customIcon }).addTo(map);
                
                // 添加彈出窗口
                marker.bindPopup(`
                    <div style="text-align: center; padding: 5px;">
                        <h4 style="margin: 0 0 5px 0; font-weight: bold;">${landmark.icon} ${landmark.name}</h4>
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 12px;">${landmark.category}</p>
                        <button onclick="openInNativeMapFromPopup('${landmark.name}', ${landmark.position[0]}, ${landmark.position[1]})" 
                                style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            🗺️ 導航
                        </button>
                    </div>
                `);
                
                // 點擊地標時跳轉到原生地圖
                marker.on('click', () => {
                    openInNativeMap(landmark);
                });
                
                landmarkMarkers.push(marker);
            });
            
            landmarksVisible = true;
            document.getElementById('toggleLandmarks').textContent = '隱藏';
            document.getElementById('landmarksBtn').querySelector('i').classList.remove('text-secondary');
            document.getElementById('landmarksBtn').querySelector('i').classList.add('text-amber-600');
            
            console.log('🏷️ 地標已顯示');
        }
        
        // 隱藏地標
        function hideLandmarks() {
            landmarkMarkers.forEach(marker => {
                marker.remove();
            });
            landmarkMarkers = [];
            
            landmarksVisible = false;
            document.getElementById('toggleLandmarks').textContent = '顯示';
            document.getElementById('landmarksBtn').querySelector('i').classList.remove('text-amber-600');
            document.getElementById('landmarksBtn').querySelector('i').classList.add('text-secondary');
            
            console.log('🏷️ 地標已隱藏');
        }
        
        // 在原生地圖中打開 (從彈出窗口調用)
        function openInNativeMapFromPopup(name, lat, lng) {
            const landmark = { name, position: [lat, lng] };
            openInNativeMap(landmark);
        }
        
        // 在原生地圖中打開
        function openInNativeMap(landmark) {
            const lat = landmark.position[0];
            const lng = landmark.position[1];
            const name = encodeURIComponent(landmark.name);
            
            // 檢測設備類型
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            // 顯示選擇對話框
            const choice = confirm(`🗺️ 要在地圖應用中打開 "${landmark.name}" 嗎？\n\n確定：使用原生地圖導航\n取消：繼續在網頁瀏覽`);
            
            if (choice) {
                if (isIOS) {
                    // iOS: 嘗試Apple Maps，失敗則用Google Maps
                    const appleMapsUrl = `maps://?q=${name}&ll=${lat},${lng}`;
                    const googleMapsUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=15`;
                    
                    try {
                        window.location.href = appleMapsUrl;
                        // 如果Apple Maps沒有安裝，1秒後跳轉到Google Maps
                        setTimeout(() => {
                            window.open(googleMapsUrl, '_blank');
                        }, 1000);
                    } catch (e) {
                        window.open(googleMapsUrl, '_blank');
                    }
                } else if (isAndroid) {
                    // Android: 使用Google Maps intent
                    const googleMapsUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=15`;
                    window.open(googleMapsUrl, '_blank');
                } else {
                    // 桌面版：打開Google Maps網頁版
                    const googleMapsUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=15`;
                    window.open(googleMapsUrl, '_blank');
                }
                
                console.log(`🚀 跳轉到原生地圖: ${landmark.name}`);
            }
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化地圖
            initMap();
            
            // 搜尋按鈕
            document.getElementById('searchBtn').addEventListener('click', () => {
                const query = document.getElementById('searchInput').value.trim();
                if (query) {
                    enhancedAddressSearch(query);
                }
            });
            
            // 搜尋框Enter鍵
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        enhancedAddressSearch(query);
                    }
                }
            });
            
            // 快速搜尋按鈕
            document.querySelectorAll('.quick-search').forEach(btn => {
                btn.addEventListener('click', () => {
                    const location = btn.getAttribute('data-location');
                    document.getElementById('searchInput').value = location;
                    enhancedAddressSearch(location);
                });
            });
            
            // 當前位置按鈕 (右上角)
            document.getElementById('currentLocationBtn').addEventListener('click', () => {
                if (userLocation) {
                    map.setView(userLocation, 16);
                    if (currentLocationMarker) {
                        currentLocationMarker.openPopup();
                    }
                } else {
                    getCurrentLocation(false);
                }
            });
            
            // 中央定位按鈕 (主要定位功能)
            document.getElementById('centerLocationBtn').addEventListener('click', () => {
                getCurrentLocation(true); // 顯示載入動畫
            });
            
            // 地標按鈕
            document.getElementById('landmarksBtn').addEventListener('click', toggleLandmarks);
            
            // 切換地標按鈕
            document.getElementById('toggleLandmarks').addEventListener('click', toggleLandmarks);
        });
        
        // 篩選標籤切換
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', function() {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>
</body>
</html> 